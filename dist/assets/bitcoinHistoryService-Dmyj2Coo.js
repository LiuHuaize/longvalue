var y=Object.defineProperty;var D=(l,t,e)=>t in l?y(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var w=(l,t,e)=>D(l,typeof t!="symbol"?t+"":t,e);import{p as T}from"./index-CFc6FiIB.js";class v{constructor(){w(this,"cache",new Map)}getCachedData(t){const e=this.cache.get(t);return e&&Date.now()-e.timestamp<e.ttl?e.data:null}setCachedData(t,e,r=24){this.cache.set(t,{data:e,timestamp:Date.now(),ttl:r*60*60*1e3})}async fetchFromCoinGecko(t,e){try{const r=new Date(t).getTime()/1e3,s=new Date(e).getTime()/1e3,c=`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart/range?vs_currency=usd&from=${r}&to=${s}`,o=await fetch(c);if(!o.ok)throw new Error(`CoinGecko APIé”™è¯¯: ${o.status}`);const a=await o.json();if(!a.prices||!Array.isArray(a.prices))throw new Error("CoinGeckoè¿”å›æ•°æ®æ ¼å¼é”™è¯¯");return a.prices.map(([i,n])=>({date:new Date(i).toISOString().split("T")[0],price:n}))}catch(r){throw console.error("CoinGeckoè·å–å¤±è´¥:",r),r}}async fetchFromYahooFinance(t,e){try{const r=Math.floor(new Date(t).getTime()/1e3),s=Math.floor(new Date(e).getTime()/1e3),c=`https://query1.finance.yahoo.com/v7/finance/download/BTC-USD?period1=${r}&period2=${s}&interval=1d&events=history`,o=await fetch(c);if(!o.ok)throw new Error(`Yahoo Finance APIé”™è¯¯: ${o.status}`);return(await o.text()).split(`
`).slice(1).filter(n=>n.trim()).map(n=>{const[d,,,,p]=n.split(",");return{date:d,price:parseFloat(p)}}).filter(n=>!isNaN(n.price))}catch(r){throw console.error("Yahoo Financeè·å–å¤±è´¥:",r),r}}async getBitcoinHistory(t="2011-01-01",e="2020-12-31"){const r=`bitcoin-history-${t}-${e}`,s=this.getCachedData(r);if(s)return s;let c=[],o="mock";try{console.log("ğŸ“ˆ é€šè¿‡ä»£ç†æœåŠ¡è·å–æ¯”ç‰¹å¸å†å²æ•°æ®...");const i=await T.fetchBitcoinHistory("max"),n=new Date(t).getTime(),d=new Date(e).getTime();c=i.filter(p=>{const m=new Date(p.date).getTime();return m>=n&&m<=d}).map(p=>({date:p.date,price:p.price})),o="proxy",console.log(`âœ… ä»£ç†æœåŠ¡æˆåŠŸè·å– ${c.length} ä¸ªæ•°æ®ç‚¹`)}catch(i){console.log("âŒ ä»£ç†æœåŠ¡å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:",i),c=this.getMockBitcoinHistory(t,e),o="mock"}const a={prices:c,startDate:t,endDate:e,dataSource:o};return this.setCachedData(r,a,24),a}getMockBitcoinHistory(t,e){const r=[],s=[{date:"2011-01-01",price:.3},{date:"2011-06-01",price:10},{date:"2011-12-01",price:3},{date:"2012-01-01",price:5},{date:"2012-12-01",price:13},{date:"2013-01-01",price:13},{date:"2013-04-01",price:100},{date:"2013-12-01",price:800},{date:"2014-01-01",price:650},{date:"2014-12-01",price:320},{date:"2015-01-01",price:315},{date:"2015-12-01",price:430},{date:"2016-01-01",price:430},{date:"2016-12-01",price:950},{date:"2017-01-01",price:1e3},{date:"2017-12-01",price:19e3},{date:"2018-01-01",price:14e3},{date:"2018-12-01",price:3200},{date:"2019-01-01",price:3700},{date:"2019-12-01",price:7200},{date:"2020-01-01",price:7200},{date:"2020-12-31",price:29e3}],c=new Date(t),o=new Date(e);for(let a=new Date(c);a<=o;a.setMonth(a.getMonth()+1)){const i=a.toISOString().split("T")[0];let n=this.interpolatePrice(i,s);const p=1+(Math.random()-.5)*.1;n*=p,r.push({date:i,price:Math.max(.01,n)})}return r.sort((a,i)=>a.date.localeCompare(i.date))}interpolatePrice(t,e){const r=new Date(t);let s=e[0],c=e[e.length-1];for(let h=0;h<e.length-1;h++){const f=new Date(e[h].date),u=new Date(e[h+1].date);if(r>=f&&r<=u){s=e[h],c=e[h+1];break}}const o=new Date(s.date),i=(new Date(c.date).getTime()-o.getTime())/(1e3*60*60*24),n=(r.getTime()-o.getTime())/(1e3*60*60*24);if(i===0)return s.price;const d=n/i,p=Math.log(s.price),m=Math.log(c.price),g=p+(m-p)*d;return Math.exp(g)}async getCurrentPrice(){try{const t=await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT");if(!t.ok)throw new Error(`Binance APIé”™è¯¯: ${t.status}`);const e=await t.json();return parseFloat(e.price)}catch(t){return console.error("è·å–å½“å‰ä»·æ ¼å¤±è´¥:",t),105e3}}}const S=new v;export{S as bitcoinHistoryService};
